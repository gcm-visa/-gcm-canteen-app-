<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
    }

    /* LOGIN STYLES */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #27ae60;
      color: white;
    }

    #login-screen input {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
      width: 220px;
    }

    #login-screen button {
      padding: 10px 20px;
      margin-top: 10px;
      background: white;
      color: #27ae60;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    #pos-app { display: none; } /* Hidden initially */

    /* --- your POS styles start here --- */
    .header {
      display: flex;
      justify-content: space-between;
      padding: 10px 20px;
      background: #27ae60;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    .container {
      display: flex;
      height: calc(100vh - 50px);
    }

    .product-panel {
      width: 60%;
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid #ddd;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
    }

    .product {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
      transition: transform 0.2s;
    }

    .product:hover { transform: scale(1.05); }
    .product img { width: 100%; height: 90px; object-fit: cover; }
    .product-name { padding: 10px; font-size: 14px; font-weight: 500; }
    .low-stock { color: red; }

    .order-panel {
      width: 40%;
      background: white;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .order-header { display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; margin-bottom: 10px; }
    .order-items { flex-grow: 1; overflow-y: auto; }

    .item-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 5px 0; }
    .item-name { flex: 1; text-align: right; padding-right: 10px; }
    .item-qty { flex: 1; display: flex; justify-content: center; align-items: center; gap: 8px; }
    .item-price { flex: 1; text-align: right; padding-right: 10px; }
    .item-qty button { padding: 4px 8px; font-size: 14px; border: none; background-color: #eee; cursor: pointer; }

    .total { font-size: 22px; font-weight: bold; text-align: right; margin-top: 10px; color: #27ae60; }

    .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .actions button {
      padding: 10px 20px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .checkout-btn { background-color: #27ae60; color: white; }
    .clear-btn { background-color: #e74c3c; color: white; }

    .sales-summary { font-size: 14px; text-align: center; margin-top: 10px; color: #888; }

    .money-input, .payment-summary {
      margin-top: 10px;
      text-align: right;
      font-size: 14px;
    }

    #money-received {
      width: 100px;
      padding: 4px;
      font-size: 14px;
      margin-left: 10px;
    }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <h2>üîê GCM Canteen Login</h2>
  <input type="text" id="login-username" placeholder="Username" />
  <input type="password" id="login-password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <div id="login-error" style="color: yellow; margin-top: 10px;"></div>
</div>

<!-- POS UI -->
<div id="pos-app">
  <div class="header">
    <div>üìã GCM Canteen Billing System ‚Äì Developed by Elvinson</div>
    <div id="clock"></div>
  </div>

  <div class="container">
    <div class="product-panel">
      <div class="product-grid" id="product-grid">Loading...</div>
    </div>

    <div class="order-panel">
      <div>
        <div class="order-header">
          <span>üßæ Order</span>
        </div>
        <div id="order-items" class="order-items"></div>
        <div class="total" id="total-amount">‚Ç±0</div>

        <div class="payment-summary">
          <div class="payment-line">
            <label for="money-received">üí∞ Money Received:</label>
            <input type="number" id="money-received" oninput="updateBalance()" />
          </div>
          <div class="payment-line">
            üîÅ Change to Return: <span id="change-amount">‚Ç±0</span>
          </div>
        </div>

        <div class="actions">
          <button class="clear-btn" onclick="clearOrder()">Clear</button>
          <button class="checkout-btn" onclick="checkoutOrder()">Checkout</button>
          <button onclick="printReceipt()">üñ®Ô∏è Print</button>
        </div>

        <div class="sales-summary" id="sales-total">Today‚Äôs Sales: ‚Ç±0</div>
      </div>
    </div>
  </div>
</div>

<script>
  let products = [];
  let orderItems = [];

  function login() {
    const username = document.getElementById("login-username").value.trim();
    const password = document.getElementById("login-password").value.trim();

    const payload = { username, password };

    google.script.run.withSuccessHandler(response => {
      if (response.status === "success") {
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("pos-app").style.display = "block";
        loadProducts();
      } else {
        document.getElementById("login-error").innerText = response.message || "Invalid credentials.";
      }
    }).doPost({ postData: { contents: JSON.stringify(payload) } });
  }

  function loadProducts() {
    google.script.run.withSuccessHandler(data => {
      products = data.map(p => ({
        id: p[0],
        name: p[1],
        price: p[2],
        stock: p[3],
        image: p[4]
      }));
      renderProducts();
    }).getProducts();

    updateSalesTotal();
    startClock();
  }

  function renderProducts() {
    const grid = document.getElementById("product-grid");
    grid.innerHTML = "";
    products.forEach(product => {
      const stockClass = product.stock <= 5 ? 'product-name low-stock' : 'product-name';
      const div = document.createElement("div");
      div.className = "product";
      div.innerHTML = `
        <img src="${product.image}" alt="${product.name}">
        <div class="${stockClass}">${product.name} (${product.stock})</div>
      `;
      div.onclick = () => {
        if (product.stock <= 0) return alert("Out of stock!");
        addToOrder(product.id);
      };
      grid.appendChild(div);
    });
  }

  function addToOrder(productId) {
    const product = products.find(p => p.id == productId);
    if (!product || product.stock <= 0) return;

    const existing = orderItems.find(item => item.id == productId);
    if (existing) {
      if (existing.qty >= product.stock) return alert("Not enough stock!");
      existing.qty += 1;
    } else {
      orderItems.push({ ...product, qty: 1 });
    }
    renderOrder();
  }

  function reduceItem(productId) {
    const item = orderItems.find(p => p.id == productId);
    if (!item) return;
    item.qty -= 1;
    if (item.qty <= 0) {
      orderItems = orderItems.filter(p => p.id != productId);
    }
    renderOrder();
  }

  function renderOrder() {
    const container = document.getElementById("order-items");
    container.innerHTML = "";
    let total = 0;

    orderItems.forEach(item => {
      total += item.price * item.qty;
      container.innerHTML += `
        <div class="item-row">
          <div class="item-name">${item.name}</div>
          <div class="item-qty">
            <button onclick="reduceItem(${item.id})">‚àí</button>
            <span>${item.qty}</span>
            <button onclick="addToOrder(${item.id})">+</button>
          </div>
          <div class="item-price">‚Ç±${(item.price * item.qty).toLocaleString()}</div>
        </div>
      `;
    });

    document.getElementById("total-amount").innerText = "‚Ç±" + total.toLocaleString();
    updateBalance();
  }

  function clearOrder() {
    orderItems = [];
    renderOrder();
  }

  function updateBalance() {
    const received = Number(document.getElementById("money-received").value);
    const totalText = document.getElementById("total-amount").innerText.replace(/[‚Ç±,]/g, '');
    const total = Number(totalText) || 0;
    const change = Math.max(received - total, 0);
    document.getElementById("change-amount").innerText = `‚Ç±${change.toLocaleString()}`;
  }

  function checkoutOrder() {
    if (orderItems.length === 0) return alert("Order is empty!");

    google.script.run.withSuccessHandler(msg => {
      alert(msg);
      clearOrder();
      updateSalesTotal();
      loadProducts();
      document.getElementById("money-received").value = "";
      document.getElementById("change-amount").innerText = "‚Ç±0";
    }).recordFullOrder(orderItems);
  }

  function updateSalesTotal() {
    google.script.run.withSuccessHandler(total => {
      document.getElementById("sales-total").innerText = "Today‚Äôs Sales: ‚Ç±" + total.toLocaleString();
    }).getTodaySalesTotal();
  }

  function startClock() {
    function updateTime() {
      const now = new Date();
      document.getElementById("clock").innerText =
        now.toLocaleDateString() + " " + now.toLocaleTimeString();
    }
    updateTime();
    setInterval(updateTime, 1000);
  }

  function printReceipt() {
    if (orderItems.length === 0) return alert("No items to print!");
    let receiptContent = `
      <h3>üßæ GCM Canteen Receipt</h3>
      <p>${new Date().toLocaleString()}</p>
      <table style="width:100%; border-collapse:collapse;">
        <tr><th style="text-align:left;">Item</th><th>Qty</th><th>Price</th></tr>
    `;
    let total = 0;
    orderItems.forEach(item => {
      total += item.qty * item.price;
      receiptContent += `
        <tr>
          <td>${item.name}</td>
          <td style="text-align:center;">${item.qty}</td>
          <td style="text-align:right;">‚Ç±${item.qty * item.price}</td>
        </tr>
      `;
    });
    receiptContent += `
      </table>
      <hr>
      <p style="text-align:right;"><strong>Total: ‚Ç±${total.toLocaleString()}</strong></p>
      <p style="font-size:12px; text-align:center;">Thank you for your order!</p>
    `;
    const receiptWindow = window.open('', 'PRINT', 'height=600,width=400');
    receiptWindow.document.write(`<html><head><title>Receipt</title></head><body>${receiptContent}</body></html>`);
    receiptWindow.document.close();
    receiptWindow.focus();
    receiptWindow.print();
  }
</script>
</body>
</html>
